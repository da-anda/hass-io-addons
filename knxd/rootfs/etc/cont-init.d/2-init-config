#!/usr/bin/with-contenv bashio

readonly CONF="/etc/knxd.ini"

# =======================================
# custom configuration
# =======================================

# first check if a custom config is specified and use that
if bashio::config.has_value 'custom_config' && bashio::config 'custom_config' -ge 5; then
  echo $(bashio::config 'custom_config') > ${CONF}
fi;

# =======================================
# auto configuration
# =======================================

# check if an interface is defined
if ! bashio::config.has_value 'interface'; then
	bashio:exit.nok "An interface type needs to be configured"
fi
	
# check if a device is selected, which is mandatory for anything but USB
if bashio::config.equals 'interface' 'usb' && ! bashio::config.has_value 'device'; then
	bashio:exit.nok "A device needs to be configured"
fi

# read the config template, replace placeholders and write it back
sed -i "s|%%INTERFACE%%|$(bashio::config 'interface')|g" "${CONF}"
sed -i "s|%%DEVICE%%|$(bashio::config 'device')|g" "${CONF}"
sed -i "s|%%ADDRESS%%|$(bashio::config 'address')|g" "${CONF}"
sed -i "s|%%CLIENT_ADDRESS%%|$(bashio::config 'client_address')|g" "${CONF}"
sed -i "s|%%FILTERS%%|$(bashio::config 'usb_filters')|g" "${CONF}"
sed -i "s|%%DEBUG_ERROR_LEVEL%%|$(bashio::config 'log_error_level')|g" "${CONF}"
